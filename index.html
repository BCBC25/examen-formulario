<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>University Examination Portal</title>

  <style>
    body { margin: 0; font-family: "Segoe UI", Roboto, Arial, sans-serif; background: linear-gradient(135deg, #eef2f7, #dbeafe); color: #1f2937; }
    .container { max-width: 900px; margin: auto; padding: 40px 20px; }
    .card { background: #ffffff; border-radius: 10px; box-shadow: 0 10px 30px rgba(0,0,0,0.12); padding: 35px; }
    h1, h2 { text-align: center; margin-top: 0; color: #0f172a; }
    input, textarea { width: 100%; margin-top: 10px; padding: 10px 12px; font-size: 15px; border-radius: 6px; border: 1px solid #cbd5e1; box-sizing: border-box; }
    button { background: #2563eb; color: #fff; border: none; border-radius: 6px; padding: 10px 18px; font-size: 15px; cursor: pointer; margin-top: 15px; }
    button:hover { background: #1e4ed8; }
    .hidden { display: none; }
    .error { color: #dc2626; margin-top: 10px; text-align: center; }
    .submit-btn { width: 100%; margin-top: 25px; font-size: 16px; }
  </style>
</head>
<body>

<!-- üîê LOGIN -->
<div class="container" id="loginScreen">
  <div class="card">
    <h2>Student Login</h2>

    <input type="text" id="loginUser" placeholder="Student ID" required>
    <input type="password" id="loginPass" placeholder="Password" required>

    <button type="button" onclick="login()">Login</button>
    <div id="loginError" class="error"></div>
  </div>
</div>

<!-- üìù EXAMEN -->
<div class="container hidden" id="examScreen">
  <div class="card">
    <h1>DRILLING TEST</h1>

    <form id="examForm">
      <input type="hidden" name="nombre" id="studentName">
      <input type="hidden" name="email" id="studentEmail">
      <input type="hidden" name="testId" value="1">

      <div id="preguntas">Loading questions...</div>

      <button type="submit" class="submit-btn">Submit Exam</button>
    </form>

    <div id="resultado"></div>
  </div>
</div>

<script>
/**
 * IMPORTANTE:
 * - Para pruebas con "Listen for test event" usa /webhook-test/...
 * - Para producci√≥n (workflow ACTIVADO) usa /webhook/...
 */
const LOGIN_URL = "https://gilloli.app.n8n.cloud/webhook-test/login-webhook";
// const LOGIN_URL = "https://gilloli.app.n8n.cloud/webhook/login-webhook"; // producci√≥n

async function login() {
  const user = document.getElementById("loginUser").value.trim();
  const pass = document.getElementById("loginPass").value;
  const errorEl = document.getElementById("loginError");
  errorEl.innerText = "";

  try {
    const res = await fetch(LOGIN_URL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ user, pass })
    });

    // Si no es 200/2xx, intenta leer el body para mostrar error real
    if (!res.ok) {
      const txt = await res.text().catch(() => "");
      throw new Error(`HTTP ${res.status} ${txt}`.trim());
    }

    // Puede venir JSON normal o envuelto, por eso lo hacemos robusto:
    const raw = await res.json();

    // Si tu Respond to Webhook tiene "Put Response in Field = response",
    // el payload real viene en raw.response:
    const data = raw?.response ?? raw;

    // Si el workflow manda {success:false,error:"..."} lo mostramos
    if (!data || data.success !== true) {
      const msg = data?.error || "Invalid username or password";
      throw new Error(msg);
    }

    // student puede venir como objeto o string (si lo armaste como string en Edit Fields)
    let student = data.student;

    // Si student viene como string tipo "{ username:..., name:..., email:... }"
    // intentamos extraer name/email de forma simple (mejor: en n8n env√≠alo como Object)
    if (typeof student === "string") {
      // intenta convertir a JSON si por casualidad viene en JSON v√°lido
      try { student = JSON.parse(student); } catch { /* ignora */ }
    }

    const name = student?.name ?? data.name;
    const email = student?.email ?? data.email;

    if (!name || !email) {
      throw new Error("Login OK pero faltan campos (name/email) en la respuesta de n8n.");
    }

    document.getElementById("studentName").value = name;
    document.getElementById("studentEmail").value = email;

    document.getElementById("loginScreen").classList.add("hidden");
    document.getElementById("examScreen").classList.remove("hidden");

  } catch (e) {
    console.error("LOGIN ERROR:", e);
    errorEl.innerText = e?.message || "Invalid username or password";
  }
}

/* ================= EXAMEN (TU C√ìDIGO ORIGINAL VA AQU√ç) ================= */
</script>

</body>
</html>
