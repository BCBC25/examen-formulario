<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<title>University Examination Portal</title>

<style>
body {
  margin: 0;
  font-family: "Segoe UI", Roboto, Arial, sans-serif;
  background: linear-gradient(135deg, #eef2f7, #dbeafe);
  color: #1f2937;
}
.container {
  max-width: 900px;
  margin: auto;
  padding: 40px 20px;
}
.card {
  background: #ffffff;
  border-radius: 10px;
  box-shadow: 0 10px 30px rgba(0,0,0,0.12);
  padding: 35px;
}
h1 { text-align: center; margin-top: 0; }
input, textarea {
  width: 100%;
  margin-top: 6px;
  padding: 10px 12px;
  font-size: 15px;
  border-radius: 6px;
  border: 1px solid #cbd5e1;
}
input[type="radio"] { width:auto; }
button {
  background: #2563eb;
  color: #fff;
  border: none;
  border-radius: 6px;
  padding: 10px 18px;
  font-size: 15px;
  cursor: pointer;
}
button:hover { background:#1e4ed8; }
.secondary-btn {
  background:#f1f5f9;
  color:#0f172a;
  border:1px solid #cbd5e1;
}
.question { margin-bottom:26px; }
.option-row { display:flex; gap:8px; margin:6px 0; }
.audio-actions { display:flex; gap:10px; margin:6px 0; }
.calc-wrapper { display:flex; gap:12px; margin-top:6px; }
.calc-value { flex:2; }
.calc-unit { flex:1; }
.submit-btn { width:100%; margin-top:25px; font-size:16px; }
.error { color:red; text-align:center; margin-top:10px; }
</style>
</head>

<body>

<div class="container">

<!-- LOGIN -->
<div class="card" id="loginCard">
  <h1>Student Login</h1>
  <input id="loginUser" placeholder="Username">
  <input id="loginPass" type="password" placeholder="Password">
  <button onclick="login()">Login</button>
  <div class="error" id="loginError"></div>
</div>

<!-- EXAMEN -->
<div class="card" id="examCard" style="display:none;">
  <h1>DRILLING TEST</h1>

  <form id="examForm">
    <label>Name</label>
    <input type="text" name="nombre" id="studentName" required>

    <label>Email</label>
    <input type="email" name="email" id="studentEmail" required>

    <input type="hidden" name="testId" value="1">
    <div id="preguntas">Loading questions...</div>

    <button type="submit" class="submit-btn">Submit Exam</button>
  </form>

  <div id="resultado"></div>
</div>

</div>

<script>
/* ================= LOGIN ================= */
const LOGIN_URL = "https://gilloli.app.n8n.cloud/webhook/login-webhook";

async function login() {
  document.getElementById("loginError").innerText = "";

  const res = await fetch(LOGIN_URL, {
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body:JSON.stringify({
      user: loginUser.value.trim(),
      pass: loginPass.value.trim()
    })
  });

  const data = await res.json();

  if (!data || data.success !== true) {
    document.getElementById("loginError").innerText = "Invalid username or password";
    return;
  }

  // Mostrar examen
  document.getElementById("loginCard").style.display = "none";
  document.getElementById("examCard").style.display = "block";

  // Autocompletar datos
  studentName.value = data.student.name;
  studentEmail.value = data.student.email;

  loadQuestions();
}

/* ================= EXAMEN (SIN CAMBIOS) ================= */

const questionsUrl = "https://script.google.com/macros/s/AKfycbwOJdDrp_XNfIQPv6mph0IhzI7W9JGZFhqErWC5YJE-UfkETADJNkB0IfYJCiEp4_pxcg/exec";
const form = document.getElementById('examForm');
const resultadoDiv = document.getElementById('resultado');

let mediaRecorder;
let audioChunks = {};

async function toggleRecording(id) {
  if (!mediaRecorder || mediaRecorder.state === "inactive") {
    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
    mediaRecorder = new MediaRecorder(stream);
    audioChunks[id] = [];
    mediaRecorder.ondataavailable = e => audioChunks[id].push(e.data);
    mediaRecorder.onstop = () => {
      const blob = new Blob(audioChunks[id], { type: "audio/webm" });
      const reader = new FileReader();
      reader.onloadend = () => {
        document.querySelector(`input[name="q${id}_audio"]`).value = reader.result;
        const audio = document.getElementById(`audio-q${id}`);
        audio.src = reader.result;
        audio.style.display = "block";
      };
      reader.readAsDataURL(blob);
    };
    mediaRecorder.start();
    document.getElementById(`rec-btn-q${id}`).innerText = "â¹ Stop";
  } else {
    mediaRecorder.stop();
    document.getElementById(`rec-btn-q${id}`).innerText = "ðŸŽ¤ Record";
  }
}

function clearAudio(id) {
  document.querySelector(`input[name="q${id}_audio"]`).value = "";
  const audio = document.getElementById(`audio-q${id}`);
  audio.src = "";
  audio.style.display = "none";
}

function updateCalc(id) {
  const wrapper = document.getElementById(`calc-q${id}`).parentElement;
  const value = wrapper.querySelector('.calc-value').value;
  const unit = wrapper.querySelector('.calc-unit').value;
  document.getElementById(`calc-q${id}`).value = `${value} ${unit}`.trim();
}

function loadQuestions() {
  fetch(questionsUrl)
  .then(r=>r.json())
  .then(preguntas=>{
    const container=document.getElementById("preguntas");
    container.innerHTML="";
    preguntas.forEach(p=>{
      const div=document.createElement("div");
      div.className="question";
      let html=`<p><strong>${p.id}. ${p.pregunta}</strong></p>`;

      if(p.tipo==="multiple option"){
        html+=`
        <label class="option-row"><input type="radio" name="q${p.id}" value="A" required> A) ${p.opcionA}</label>
        <label class="option-row"><input type="radio" name="q${p.id}" value="B"> B) ${p.opcionB}</label>
        <label class="option-row"><input type="radio" name="q${p.id}" value="C"> C) ${p.opcionC}</label>
        <label class="option-row"><input type="radio" name="q${p.id}" value="D"> D) ${p.opcionD}</label>`;
      }
      else if(p.tipo==="open-ended"){
        html+=`
        <textarea name="q${p.id}" rows="4"></textarea>
        <div class="audio-actions">
          <button type="button" id="rec-btn-q${p.id}" onclick="toggleRecording(${p.id})">ðŸŽ¤ Record</button>
          <button type="button" class="secondary-btn" onclick="clearAudio(${p.id})">ðŸ—‘ Clear</button>
        </div>
        <audio id="audio-q${p.id}" controls style="display:none;"></audio>
        <input type="hidden" name="q${p.id}_audio">`;
      }
      else if(p.tipo==="calculation"){
        html+=`
        <div class="calc-wrapper">
          <input type="number" class="calc-value" oninput="updateCalc(${p.id})" required>
          <input type="text" class="calc-unit" oninput="updateCalc(${p.id})" required>
          <input type="hidden" name="q${p.id}" id="calc-q${p.id}">
        </div>`;
      }
      else if(p.tipo==="true/false"){
        html+=`
        <label class="option-row"><input type="radio" name="q${p.id}" value="true" required> True</label>
        <label class="option-row"><input type="radio" name="q${p.id}" value="false"> False</label>`;
      }

      div.innerHTML=html;
      container.appendChild(div);
    });
  });
}

form.addEventListener("submit", async e=>{
  e.preventDefault();
  const fd=new FormData(form);
  const payload={
    nombre:fd.get("nombre"),
    email:fd.get("email"),
    testId:fd.get("testId"),
    answers:[]
  };
  for(const [k,v] of fd.entries()){
    if(k.startsWith("q") && v){
      payload.answers.push({questionId:k.substring(1),answer:v});
    }
  }
  await fetch("https://gilloli.app.n8n.cloud/webhook/student-exam-submission",{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify(payload)
  });
  resultadoDiv.innerText="Exam submitted successfully.";
});
</script>

</body>
</html>
