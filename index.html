<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>University Examination Portal</title>

  <style>
    body {
      margin: 0;
      font-family: "Segoe UI", Roboto, Arial, sans-serif;
      background: linear-gradient(135deg, #eef2f7, #dbeafe);
      color: #1f2937;
    }

    .container {
      max-width: 900px;
      margin: auto;
      padding: 40px 20px;
    }

    .card {
      background: #ffffff;
      border-radius: 10px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.12);
      padding: 35px;
    }

    h1 {
      text-align: center;
      margin-top: 0;
      color: #0f172a;
    }

    label {
      font-weight: 400;
    }

    input, textarea {
      width: 100%;
      margin-top: 6px;
      padding: 10px 12px;
      font-size: 15px;
      border-radius: 6px;
      border: 1px solid #cbd5e1;
    }

    textarea {
      resize: vertical;
    }

    button {
      background: #2563eb;
      color: #fff;
      border: none;
      border-radius: 6px;
      padding: 8px 16px;
      font-size: 14px;
      cursor: pointer;
    }

    button:hover {
      background: #1e4ed8;
    }

    .secondary-btn {
      background: #f1f5f9;
      color: #0f172a;
      border: 1px solid #cbd5e1;
    }

    .secondary-btn:hover {
      background: #e2e8f0;
    }

    .question {
      margin-bottom: 26px;
    }

    /* ===== MULTIPLE CHOICE PERFECT ALIGN ===== */
    .multiple-options .option-row {
      display: flex;
      align-items: center;
      gap: 10px;
      margin: 6px 0;
      cursor: pointer;
    }

    .multiple-options .option-row input[type="radio"] {
      margin: 0;
      flex: 0 0 auto;
    }

    .multiple-options .option-row span {
      flex: 1;
    }

    /* ===== TRUE / FALSE ===== */
    .truefalse .option-row {
      display: flex;
      align-items: center;
      gap: 10px;
      margin: 6px 0;
      cursor: pointer;
    }

    /* ===== OPEN ENDED + AUDIO ===== */
    .open-question textarea {
      border: 1px solid #94a3b8;
    }

    .audio-actions {
      display: flex;
      gap: 10px;
      margin-top: 6px;
      margin-bottom: 6px;
    }

    audio {
      width: 100%;
      margin-top: 6px;
    }

    .submit-btn {
      width: 100%;
      margin-top: 25px;
      font-size: 16px;
    }
  </style>
</head>
<body>

  <div class="container">
    <div class="card">
      <h1>DRILLING TEST</h1>

      <form id="examForm">
        <label>Name</label>
        <input type="text" name="nombre" required>

        <label>Email</label>
        <input type="email" name="email" required>

        <input type="hidden" name="testId" value="1">

        <div id="preguntas">Loading questions...</div>

        <button type="submit" class="submit-btn">Submit Exam</button>
      </form>

      <div id="resultado"></div>
    </div>
  </div>

  <script>
    const questionsUrl = "https://script.google.com/macros/s/AKfycbwOJdDrp_XNfIQPv6mph0IhzI7W9JGZFhqErWC5YJE-UfkETADJNkB0IfYJCiEp4_pxcg/exec";
    const form = document.getElementById('examForm');
    const resultadoDiv = document.getElementById('resultado');

    let mediaRecorder;
    let audioChunks = {};

    async function toggleRecording(id) {
      if (!mediaRecorder || mediaRecorder.state === "inactive") {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        mediaRecorder = new MediaRecorder(stream);
        audioChunks[id] = [];

        mediaRecorder.ondataavailable = e => audioChunks[id].push(e.data);

        mediaRecorder.onstop = () => {
          const blob = new Blob(audioChunks[id], { type: "audio/webm" });
          const reader = new FileReader();
          reader.onloadend = () => {
            document.querySelector(`input[name="q${id}_audio"]`).value = reader.result;
            const audio = document.getElementById(`audio-q${id}`);
            audio.src = reader.result;
            audio.style.display = "block";
          };
          reader.readAsDataURL(blob);
        };

        mediaRecorder.start();
        document.getElementById(`rec-btn-q${id}`).innerText = "â¹ Stop";
      } else {
        mediaRecorder.stop();
        document.getElementById(`rec-btn-q${id}`).innerText = "ðŸŽ¤ Record";
      }
    }

    function clearAudio(id) {
      document.querySelector(`input[name="q${id}_audio"]`).value = "";
      const audio = document.getElementById(`audio-q${id}`);
      audio.src = "";
      audio.style.display = "none";
    }

    fetch(questionsUrl)
      .then(res => res.json())
      .then(preguntas => {
        const container = document.getElementById("preguntas");
        container.innerHTML = "";

        preguntas.forEach(p => {
          const tipo = p.tipo;
          const div = document.createElement("div");
          div.className = "question";

          let html = `<p><strong>${p.id}. ${p.pregunta}</strong></p>`;

          if (tipo === "multiple option") {
            html += `
              <div class="multiple-options">
                <label class="option-row"><input type="radio" name="q${p.id}" value="A" required><span>A) ${p.opcionA}</span></label>
                <label class="option-row"><input type="radio" name="q${p.id}" value="B"><span>B) ${p.opcionB}</span></label>
                <label class="option-row"><input type="radio" name="q${p.id}" value="C"><span>C) ${p.opcionC}</span></label>
                <label class="option-row"><input type="radio" name="q${p.id}" value="D"><span>D) ${p.opcionD}</span></label>
              </div>
            `;
          } 
          else if (tipo === "open-ended") {
            html += `
              <div class="open-question">
                <textarea name="q${p.id}" rows="4"
                  placeholder="Write your answer or record audio"></textarea>

                <div class="audio-actions">
                  <button type="button" id="rec-btn-q${p.id}"
                    onclick="toggleRecording(${p.id})">ðŸŽ¤ Record</button>

                  <button type="button" class="secondary-btn"
                    onclick="clearAudio(${p.id})">ðŸ—‘ Clear audio</button>
                </div>

                <audio id="audio-q${p.id}" controls style="display:none;"></audio>
                <input type="hidden" name="q${p.id}_audio" />
              </div>
            `;
          }
          else if (tipo === "true/false") {
            html += `
              <div class="truefalse">
                <label class="option-row"><input type="radio" name="q${p.id}" value="true" required><span>True</span></label>
                <label class="option-row"><input type="radio" name="q${p.id}" value="false"><span>False</span></label>
              </div>
            `;
          }
          else if (tipo === "calculation") {
            html += `<input type="number" name="q${p.id}" step="any" required>`;
          }
          else {
            html += `<input type="text" name="q${p.id}" required>`;
          }

          div.innerHTML = html;
          container.appendChild(div);
        });
      });

    form.addEventListener('submit', async e => {
      e.preventDefault();
      const formData = new FormData(form);

      const payload = {
        nombre: formData.get('nombre'),
        email: formData.get('email'),
        testId: formData.get('testId'),
        answers: []
      };

      for (const [key, value] of formData.entries()) {
        if (key.startsWith('q') && value) {
          payload.answers.push({
            questionId: key.substring(1),
            answer: value
          });
        }
      }

      await fetch('https://gilloli.app.n8n.cloud/webhook/student-exam-submission', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });

      resultadoDiv.innerText = "Exam submitted successfully.";
      form.reset();
    });
  </script>
</body>
</html>
