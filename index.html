<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>TEST</title>
</head>
<body>
  <h1>DRILLING TEST</h1>

  <form id="examForm">
    <label>Name:<br>
      <input type="text" name="nombre" required />
    </label><br /><br />

    <label>Email:<br>
      <input type="email" name="email" required />
    </label><br /><br />

    <input type="hidden" name="testId" value="1" />

    <div id="preguntas">Loading questions...</div>

    <button type="submit">Send exam</button>
  </form>

  <div id="resultado"></div>

  <script>
    const questionsUrl = "https://script.google.com/macros/s/AKfycbwOJdDrp_XNfIQPv6mph0IhzI7W9JGZFhqErWC5YJE-UfkETADJNkB0IfYJCiEp4_pxcg/exec";
    const form = document.getElementById('examForm');
    const resultadoDiv = document.getElementById('resultado');

    // ---- AUDIO HELPERS ----
    const recorders = {};
    const audioChunks = {};
    const audioStreams = {};

    async function toggleRecording(questionId) {
      const btn = document.getElementById(`rec-btn-q${questionId}`);
      const hidden = document.querySelector(`input[name="q${questionId}_audio"]`);
      const audioEl = document.getElementById(`audio-q${questionId}`);

      if (recorders[questionId]?.state === "recording") {
        recorders[questionId].stop();
        btn.textContent = "ðŸŽ¤ Record";
        return;
      }

      const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
      audioStreams[questionId] = stream;

      const mr = new MediaRecorder(stream);
      recorders[questionId] = mr;
      audioChunks[questionId] = [];

      mr.ondataavailable = e => e.data.size && audioChunks[questionId].push(e.data);

      mr.onstop = () => {
        audioStreams[questionId]?.getTracks().forEach(t => t.stop());

        const blob = new Blob(audioChunks[questionId], { type: "audio/webm" });
        const reader = new FileReader();

        reader.onloadend = () => {
          hidden.value = reader.result;
          audioEl.src = reader.result;
          audioEl.style.display = "block";
        };

        reader.readAsDataURL(blob);
      };

      mr.start();
      btn.textContent = "â¹ Stop";
    }

    function clearAudio(questionId) {
      document.querySelector(`input[name="q${questionId}_audio"]`).value = "";
      const audioEl = document.getElementById(`audio-q${questionId}`);
      audioEl.src = "";
      audioEl.style.display = "none";
    }
    // ---- END AUDIO HELPERS ----

    // Cargar preguntas
    fetch(questionsUrl)
      .then(res => res.json())
      .then(preguntas => {
        const container = document.getElementById("preguntas");
        container.innerHTML = "";

        preguntas.forEach(p => {
          const tipo = (p.tipo || "")
            .toLowerCase()
            .trim()
            .replace("_", "-");

          const div = document.createElement("div");
          let html = `<p>${p.id}. ${p.pregunta}</p>`;

          if (tipo.includes("multiple")) {
            html += `
              <label><input type="radio" name="q${p.id}" value="A" required> A) ${p.opcionA}</label><br>
              <label><input type="radio" name="q${p.id}" value="B"> B) ${p.opcionB}</label><br>
              <label><input type="radio" name="q${p.id}" value="C"> C) ${p.opcionC}</label><br>
              <label><input type="radio" name="q${p.id}" value="D"> D) ${p.opcionD}</label><br>
            `;
          } else if (tipo.includes("open")) {
            html += `
              <textarea name="q${p.id}" rows="4" cols="60"
                placeholder="Write your answer or record audio"></textarea><br>

              <button type="button" id="rec-btn-q${p.id}"
                onclick="toggleRecording(${p.id})">ðŸŽ¤ Record</button>

              <button type="button" onclick="clearAudio(${p.id})">ðŸ—‘ Clear audio</button><br>

              <audio id="audio-q${p.id}" controls style="display:none; margin-top:6px;"></audio>

              <input type="hidden" name="q${p.id}_audio" />
            `;
          } else if (tipo.includes("true")) {
            html += `
              <label><input type="radio" name="q${p.id}" value="true" required> True</label><br>
              <label><input type="radio" name="q${p.id}" value="false"> False</label><br>
            `;
          } else if (tipo.includes("calc")) {
            html += `<input type="number" name="q${p.id}" step="any" required>`;
          } else {
            html += `<input type="text" name="q${p.id}">`;
          }

          div.innerHTML = html;
          container.appendChild(div);
          container.appendChild(document.createElement("br"));
        });
      })
      .catch(err => {
        document.getElementById("preguntas").innerText = "Error loading questions.";
        console.error(err);
      });

    // EnvÃ­o del formulario (SIN CAMBIOS)
    form.addEventListener('submit', async e => {
      e.preventDefault();
      const formData = new FormData(form);

      const payload = {
        nombre: formData.get('nombre'),
        email: formData.get('email'),
        testId: formData.get('testId'),
        answers: []
      };

      for (const [key, value] of formData.entries()) {
        if (key.startsWith('q') && value) {
          payload.answers.push({
            questionId: key.substring(1),
            answer: value
          });
        }
      }

      try {
        resultadoDiv.innerText = "Submitting exam...";
        const res = await fetch(
          'https://gilloli.app.n8n.cloud/webhook/student-exam-submission',
          {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
          }
        );

        resultadoDiv.innerText = res.ok
          ? "Exam submitted successfully."
          : "Error submitting exam.";
      } catch (err) {
        resultadoDiv.innerText = "Network error.";
        console.error(err);
      }
    });
  </script>
</body>
</html>
